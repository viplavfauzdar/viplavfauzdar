name: Update profile README

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # every Monday 06:00 UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v4

      - name: Install jq (for JSON parsing)
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Medium (top 5)
        id: medium
        shell: bash
        run: |
          set -euo pipefail
          FEED_URL="https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Fmedium.com%2Ffeed%2F%40viplav.fauzdar"
          curl -fsSL "$FEED_URL" | jq -r '
            def ic(t):
              if (t|test("STRIDE|threat|security";"i")) then "🔐"
              elif (t|test("HVAC|DIY|Raspberry|Garage";"i")) then "🔧"
              elif (t|test("Spring|Java|API|ELK|Log";"i")) then "🛠️"
              elif (t|test("OpenAI|GPT|LLM|Ollama";"i")) then "🤖"
              elif (t|test("LSTM|Trading|Stock|Market";"i")) then "📈"
              elif (t|test("Stream|Streaming";"i")) then "📡"
              else "✍️" end;
            .items[0:5]
            | map("- " + ic(.title) + " [" + .title + "]( " + .link + ")")
            | join("\n")
          ' > medium_list.md

      - name: Insert/Update Medium section above DIY Projects
        shell: bash
        run: |
          set -euo pipefail
          README_FILE="README.md"
          START="<!-- medium:start -->"
          END="<!-- medium:end -->"

          # 1) Build the Medium section into a temp file
          {
            echo "## Latest on Medium"
            echo "$START"
            cat medium_list.md
            echo "$END"
            echo
          } > medium_section.tmp

          # 2) Remove any existing Medium block (between START/END) from README
          awk -v START="$START" -v END="$END" '
            BEGIN{inblk=0}
            index($0, START){ inblk=1; next }
            index($0, END){ inblk=0; next }
            !inblk{ print }
          ' "$README_FILE" > README.clean

          # 3) Insert the section before the DIY Projects heading
          #    If the DIY heading isn't found, append at end.
          if grep -q '^##[[:space:]]*🛠️[[:space:]]*DIY Projects' README.clean; then
            awk '
              /^##[[:space:]]*🛠️[[:space:]]*DIY Projects/ {
                system("cat medium_section.tmp");
                print; next
              }
              { print }
            ' README.clean > README.new
          else
            cat README.clean medium_section.tmp > README.new
          fi

          mv README.new "$README_FILE"
          rm -f README.clean medium_section.tmp

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "chore: refresh profile README"
            git push
          fi
