name: Update profile README

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1" # every Monday 06:00 UTC

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout profile repo
        uses: actions/checkout@v4

      - name: Install jq (for JSON parsing)
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch Medium (top 5)
        id: medium
        shell: bash
        run: |
          set -euo pipefail
          FEED_URL="https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Fmedium.com%2Ffeed%2F%40viplav.fauzdar"
          curl -fsSL "$FEED_URL" | jq -r '
            .items[0:5] | map("- [" + .title + "](" + .link + ")") | join("\n")
          ' > medium_list.md

      - name: Update Medium section in README
        shell: bash
        run: |
          set -euo pipefail
          README_FILE="README.md"
          START="<!-- medium:start -->"
          END="<!-- medium:end -->"

          if ! grep -q "$START" "$README_FILE" || ! grep -q "$END" "$README_FILE"; then
            echo "Markers not found; appending section to end of README."
            {
              echo
              echo "## Latest on Medium"
              echo "$START"
              cat medium_list.md
              echo "$END"
            } >> "$README_FILE"
          else
            awk -v START="$START" -v END="$END" '
              BEGIN{inblk=0}
              index($0, START){ print; system("cat medium_list.md"); inblk=1; next }
              index($0, END){ print; inblk=0; next }
              !inblk{ print }
            ' "$README_FILE" > README.new
            mv README.new "$README_FILE"
          fi

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -e
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "chore: refresh profile README"
            git push
          fi